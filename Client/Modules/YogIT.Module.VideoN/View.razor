@using YogIT.Module.VideoN.Models
@using YogIT.Module.VideoN.Services

@namespace YogIT.Module.VideoN
@inherits LocalizableComponent
@inject IStringLocalizer<Index> Localizer
@inject IVideoNService VideoNService

@if (_videoN != null)
{
    <h3>@_videoN.Title</h3>
    <Player Id="@_playerKey.ToString()" Url="@_videoN.Source" Poster="@_videoN.Poster" TechOrder="@_videoN.TechOrder" @key="_playerKey" />
    <div>@_videoN.Description</div>
}

@code {
    private VideoN _videoN;
    private string _playerKey;

    public override List<Resource> Resources => new List<Resource>()
    {
        new Resource { ResourceType = Oqtane.Shared.ResourceType.Script, Url = ModulePath() + "videojs/videojs.min.js" },  
        new Resource { ResourceType = Oqtane.Shared.ResourceType.Stylesheet, Url = ModulePath() + "videojs/videojs.min.css" }, 
        new Resource { ResourceType = Oqtane.Shared.ResourceType.Stylesheet, Url = ModulePath() + "Module.css" }
    };

    protected override async Task OnInitializedAsync()
    {
        var id = Int32.Parse(PageState.QueryString["id"]);
        try
        {
            Random generator = new Random();
            _playerKey = generator.Next(100000, 999999).ToString();
            _videoN = await VideoNService.GetVideoNAsync(id, ModuleState.ModuleId);
            _videoN.TechOrder = _videoN.SourceType.Equals("YouTube") ? "youtube" : "html5";
            _videoN.SourceType = _videoN.SourceType.Equals("YouTube") ? "video/youtube" : "video/mp4";
            _videoN.Poster = string.IsNullOrEmpty(_videoN.Poster) ? ModulePath() + "videojs/poster.png" : _videoN.Poster;
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error Loading VideoN {VideoNId} {Error}", id, ex.Message);
            AddModuleMessage(Localizer["Message.LoadError"], MessageType.Error);
        }
    }
}
